`性能优化`

## 什么是ANR？

如果 Android 应用的 UI 线程处于阻塞状态的时间过长，会触发“应用无响应”(ANR) 错误。

ANR 是一个问题，因为负责更新界面的应用主线程无法处理用户输入事件或绘制操作，引起用户的不满。如需详细了解应用的主线程，请参阅进程和线程。

出现以下任何情况时，系统都会针对您的应用触发 ANR：

1. 当您的 Activity 位于前台时，您的应用在 5 秒钟内未响应输入事件或BroadcastReceiver（如按键或屏幕轻触事件）。

2. 虽然前台没有 Activity，但您的 BroadcastReceiver 用了相当长的时间仍未执行完毕。


## 诊断 ANR 时需要考虑以下几种常见模式

1. 应用在**主线程**上非常缓慢地执行涉及 **I/O** 的操作。
2. 应用在**主线程**上进行长时间的**计算**。
3. 主线程在对**另一个进程进行同步 Binder 调用**，而后者需要很长时间才能返回。
4. **主线程处于阻塞状态**，为发生在另一个线程上的长操作等待同步的块。
5. 主线程在进程中或通过 **Binder 调用**与另一个线程之间**发生死锁**。主线程不只是在等待长操作执行完毕，而且处于死锁状态。如需更多信息，请参阅维基百科上的死锁。


## 诊断方法

#### 1. 严格模式

使用 **StrictMode** 有助于您在开发应用时发现主线程上的意外 I/O 操作。您可以在应用级别或 Activity 级别使用 。

#### 2. 启用后台 ANR 对话框
只有在设备的开发者选项中启用了显示所有 ANR 时，Android 才会针对花费过长时间处理广播消息的应用显示 ANR 对话框。因此，系统并不会始终向用户显示后台 ANR 对话框，但应用仍可能会遇到性能问题。

#### 3. TraceView
您可以使用 TraceView 在查看用例时获取正在运行的应用的跟踪信息，并找出主线程繁忙的位置。如需了解如何使用 TraceView，请参阅使用 TraceView 和 dmtracedump 分析性能。

#### 4. 拉取跟踪信息文件
Android 会在遇到 ANR 时存储跟踪信息。在较低的操作系统版本中，设备上只有一个 /data/anr/traces.txt 文件。在较新的操作系统版本中，有多个 /data/anr/anr_* 文件

#### 5. 使用 ANR-WatchDog

ANR-WatchDog 会单独开一个线程，定时向主线程发送消息，如果没能及时收到说明发生了 ANR

## 链接
[Android Developer：ANR](https://developer.android.google.cn/topic/performance/vitals/anr#top_of_page)

